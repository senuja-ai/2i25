<!DOCTYPE html>
<html>
<head>
  <title>ðŸ¦– The 2i Dino Survival Game</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f1f1f1;
      overflow-x: hidden;
    }
    #gameContainer {
      position: relative;
      border: 3px solid black;
      background: #e6e6e6;
      margin-top: 0;
      width: 100%;
    }
    #gameCanvas {
      display: block;
      width: 100vw;
      height: 60vh;
      background: linear-gradient(#aee1f9, #f1f1f1);
    }
    #overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 32px;
      visibility: hidden;
      text-align: center;
    }
    #leaderboard {
      width: 100%;
      max-width: 700px;
      border: 3px solid black;
      margin: 10px 0;
      background: #fdfdfd;
    }
    #leaderboard h2 {
      text-align: center;
      margin: 8px 0;
      border-bottom: 2px solid black;
      padding-bottom: 4px;
    }
    #scoresList {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    #scoresList li {
      border: 1px solid #ccc;
      margin: 2px;
      padding: 4px;
      text-align: center;
      font-size: 14px;
      background: #f9f9f9;
    }
    #scoresList li strong {
      color: darkblue;
    }
    #countdownOverlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 100px;
      font-weight: bold;
      color: white;
      background: rgba(0,0,0,0.7);
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1>ðŸ¦– The 2i Dino Survival Game</h1>
  <div id="gameContainer">
    <canvas id="gameCanvas" width="600" height="200"></canvas>
    <div id="overlay"></div>
    <div id="countdownOverlay"></div>
  </div>
  <div id="leaderboard">
    <h2>Leaderboard</h2>
    <ul id="scoresList"></ul>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // ðŸ”‘ Replace with your project details
    const SUPABASE_URL = "https://lmuaighljyvczobprzyz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtdWFpZ2hsanl2Y3pvYnByenl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMjIyODAsImV4cCI6MjA3NDg5ODI4MH0.j2TfU7pYJjo9vkqPNq7U7txN4akTty_-K4Pky_o6kRo";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Classmate names
    const names = [
      "Andrew","Ahmed","Aimen","Alexandra","Alvina","Anabelle","Anas","Aneeqa","Arta","Asya","Augus",
      "Ayeza","Aymen","Bodhit","Carolina","Daria","Emma","Fatima","Helin","Hussein","Iasmina",
      "Jannatul","Jeet","Jonas","Karina","Karl","Khaliil","Kiarad","Kruthika","Logan","Lohita",
      "Louis","Luca","Laasya","Mahnaz","Milena","Milo","Navid","Parnian","Rinko","Raamish","Sam",
      "Selini","Senuja","Artemis","Shaazil","Sofiia","Soha","Sorena","Spandana","Sunny","Taha",
      "Tymur","Volodymyr","Wania","Zakariya","Zidane","Zoha"
    ];

    // Ask for player name
    let playerName = "";
    while(true){
      let input = prompt("Enter your first name as on lectio or nickname (if this prompt is repeated, try again):");
      if(!input) continue;
      input = input.trim();
      let match = names.find(n => n.toLowerCase() === input.toLowerCase());
      if(match){ playerName = match; break; }
    }

    // Save score
    async function saveScore(name, score) {
    // Fetch current score
    const { data, error: fetchError } = await supabaseClient
      .from("scores")
      .select("score")
      .eq("player", name)
      .single();

    if (fetchError && fetchError.code !== "PGRST116") { // ignore "not found"
      console.error("Fetch error:", fetchError);
      return;
    }

    const currentScore = data ? data.score : 0;
    // Only update if new score is higher
    if (score > currentScore) {
      const { error: updateError } = await supabaseClient
        .from("scores")
        .upsert([{ player: name, score }], { onConflict: ["player"] });

    if (updateError) console.error("Save error:", updateError);
      }
    }


    // make sure everyones scores are initialized
    async function initializeScores() {
      for (const name of names) {
        // Check if the player already has a row
        const { data, error } = await supabaseClient
          .from("scores")
          .select("*")
          .eq("player", name)
          .limit(1);
        if (error) {
          console.error("Error fetching score for", name, error);
          continue;
        }
        // If the player has no score yet, insert 0
        if (!data || data.length === 0) {
          await supabaseClient
            .from("scores")
            .insert([{ player: name, score: 0 }]);
        }
      }
    }


    // Fetch scores
    async function fetchScores(){
      const { data, error } = await supabaseClient
        .from("scores")
        .select("*")
        .order("score", { ascending: false });
      if(error){
        console.error("Fetch error:", error);
        return [];
      }
      return data;
    }

    // Update leaderboard
    async function updateLeaderboard(){
      const ul = document.getElementById("scoresList");
      ul.innerHTML = "";
      const scores = await fetchScores();
      scores.forEach(({ player, score }) => {
        const li = document.createElement("li");
        li.innerHTML = player === playerName ? `<strong>${player}: ${score}</strong>` : `${player}: ${score}`;
        ul.appendChild(li);
      });
    }
    updateLeaderboard();

    // Subscribe to real-time changes
    supabaseClient
      .channel("leaderboard")
      .on("postgres_changes", { event: "*", schema: "public", table: "scores" },
        (payload) => updateLeaderboard()
      )
      .subscribe();

    // Game setup
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const overlay = document.getElementById("overlay");
    const countdownOverlay = document.getElementById("countdownOverlay");

    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight * 0.6;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    let dino = {x:canvas.width-80, y:150, width:40, height:40, dy:0, jumping:false};
    let gravity = 0.6;
    let obstacles = [];
    let score = 0;
    let gameOver = false;
    let groundHeight = 20;
    let lastJumpTime = 0;
    let survivalInterval;

    // Particles
    let particles = [];
    function spawnParticles(x, y, color){
      for(let i=0;i<20;i++){
        particles.push({
          x, y,
          dx:(Math.random()-0.5)*18,
          dy:(Math.random()-2)*12,
          size:Math.random()*20+3,
          color
        });
      }
    }
    function drawParticles(){
      particles.forEach((p,i)=>{
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        ctx.fill();
        p.x+=p.dx;
        p.y+=p.dy;
        p.dy+=0.2;
        p.size*=0.95;
        if(p.size<0.5) particles.splice(i,1);
      });
    }

    // Obstacles
    function spawnObstacle(){
      if(gameOver) return;
      const size = 40 + Math.random()*30;
      const treeEmojis = ["ðŸŒ³","ðŸŒ²","ðŸŒ´"];
      const emoji = treeEmojis[Math.floor(Math.random()*treeEmojis.length)];
      obstacles.push({
        x: -size,
        y: canvas.height-groundHeight-size,
        size,
        emoji
      });
      const nextTime = 800 + Math.random()*1200;
      setTimeout(spawnObstacle, nextTime);
    }

    // Jump
    function jump(){
      const now = Date.now();
      if(!dino.jumping && !gameOver && now - lastJumpTime > 200){
        dino.dy = -12;
        dino.jumping = true;
        lastJumpTime = now;
      }
    }
    document.addEventListener("keydown", e => {
      if (e.code === "Space" || e.code === "ArrowUp" || e.code === "KeyW") {
        jump();
      }
    });
    document.addEventListener("touchstart", jump);
    document.addEventListener("click", jump);

    // End game
    async function endGame(){
    gameOver = true;
    // Fetch their best score
    const { data, error } = await supabaseClient
      .from("scores")
      .select("score")
      .eq("player", playerName)
      .single();

    const bestScore = data ? data.score : score;

    overlay.textContent = `GAME OVER! | Your score: ${score} | Best score: ${bestScore} | (reload page to try again!)`;
    overlay.style.visibility = "visible";

    clearInterval(survivalInterval);
    await saveScore(playerName, score);
    }


    // Game loop
    function gameLoop(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle="#444";
      ctx.fillRect(0,canvas.height-groundHeight,canvas.width,groundHeight);

      ctx.font = `${dino.height}px Arial`;
      ctx.fillText("ðŸ¦–", dino.x, dino.y + dino.height-5);

      dino.y += dino.dy;
      dino.dy += gravity;
      if(dino.y > canvas.height-groundHeight-dino.height){
        dino.y = canvas.height-groundHeight-dino.height;
        dino.dy = 0;
        dino.jumping = false;
      }

      obstacles.forEach((ob,i)=>{
        ob.x += 5;
        ctx.font = `${ob.size}px Arial`;
        ctx.fillText(ob.emoji, ob.x, ob.y + ob.size-5);

        const dinoBox = {x:dino.x+5,y:dino.y+5,width:dino.width-10,height:dino.height-10};
        const obBox = {x:ob.x + ob.size*0.2, y:ob.y + ob.size*0.2, width:ob.size*0.6, height:ob.size*0.6};
        if(dinoBox.x < obBox.x+obBox.width && dinoBox.x+dinoBox.width>obBox.x &&
           dinoBox.y < obBox.y+obBox.height && dinoBox.y+dinoBox.height>obBox.y){
          endGame();
        }
        if(ob.x - ob.size > canvas.width) obstacles.splice(i,1);
      });

      drawParticles();

      if(!gameOver) requestAnimationFrame(gameLoop);
    }

    // Countdown
    function startCountdown(){
      let count = 3;
      countdownOverlay.style.visibility = "visible";
      countdownOverlay.textContent = count;

      let countdownInterval = setInterval(()=>{
        spawnParticles(canvas.width/2, canvas.height/3, `hsl(${Math.random()*360},80%,60%)`);
        count--;
        if(count>0){
          countdownOverlay.textContent = count;
        } else if(count===0){
          countdownOverlay.textContent = "GO!";
          spawnParticles(canvas.width/2, canvas.height/3, "gold");
        } else {
          clearInterval(countdownInterval);
          countdownOverlay.style.visibility = "hidden";

          survivalInterval = setInterval(()=>{
            if(!gameOver){
              score +=10;
              saveScore(playerName, score);
              updateLeaderboard();
            }
          },3000);
          spawnObstacle();
          gameLoop();
        }
      },1000);
    }

    startCountdown();
    
    ctx.fillStyle = "black";
    ctx.font = "24px Arial";
    ctx.fillText(`Score: ${score}`, 20, 40);

  </script>
</body>
</html>







